{% extends "base.html" %}

{% block content %}
<div id="notification-container" class="fixed bottom-4 right-4 space-y-2 z-50">
    {% for message in get_flashed_messages() %}
    <div role="alert" class="alert alert-success" data-index="{{ loop.index0 }}">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24" id="close-notif-{{ loop.index0 }}">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
  <span>{{message}}</span>
</div>
    {% endfor %}
</div>

<div class="container mx-auto p-4 min-h-screen flex flex-col">
<div class="container mx-auto p-4">
    <div id="welcome-section" class="flex flex-col items-center justify-center">
        <svg class="w-20 h-20 text-gray-800 dark:text-white opacity-60 pb-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18.5A2.493 2.493 0 0 1 7.51 20H7.5a2.468 2.468 0 0 1-2.4-3.154 2.98 2.98 0 0 1-.85-5.274 2.468 2.468 0 0 1 .92-3.182 2.477 2.477 0 0 1 1.876-3.344 2.5 2.5 0 0 1 3.41-1.856A2.5 2.5 0 0 1 12 5.5m0 13v-13m0 13a2.493 2.493 0 0 0 4.49 1.5h.01a2.468 2.468 0 0 0 2.403-3.154 2.98 2.98 0 0 0 .847-5.274 2.468 2.468 0 0 0-.921-3.182 2.477 2.477 0 0 0-1.875-3.344A2.5 2.5 0 0 0 14.5 3 2.5 2.5 0 0 0 12 5.5m-8 5a2.5 2.5 0 0 1 3.48-2.3m-.28 8.551a3 3 0 0 1-2.953-5.185M20 10.5a2.5 2.5 0 0 0-3.481-2.3m.28 8.551a3 3 0 0 0 2.954-5.185"/>
        </svg>
    <h1 class="text-2xl font-normal pb-2">Â¡Mi nombre es Pwnie! Â¿Sobre quÃ© te gustarÃ­a hablar?</h1>
    <p class="text-lg font-light text-inherit opacity-60">Puedo ayudarte a repasar temas de ciberseguridad de manera Ã©tica.</p>
    <p class="text-lg font-light text-inherit opacity-60 pt-10">Prueba las siguientes preguntas:</p>
    <div class="flex flex-wrap justify-center gap-2 mt-4 max-w-xl mx-auto">

        {% for question in [
            "Â¿QuÃ© es la ciberseguridad?",
            "Â¿CÃ³mo proteger mis dispositivos de malware?",
            "Â¿QuÃ© es un ataque de phishing?",
            "Â¿CÃ³mo puedo mejorar la seguridad de mis contraseÃ±as?",
            ]%}
            <button
            class="btn btn-outline rounded-lg text-base whitespace-nowrap"
            onclick="quickSend('{{ question }}')"
            >
            {{ question }}
            </button>
        {% endfor %}
    </div>
</div>
    
    <div id="chat-box" class="p-4 w-full overflow-y-auto h-[650px] hidden"></div>
        <!-- Messages will be displayed here -->
    </div>
    

    <div class="flex items-center rounded-lg bg-base-200 p-2 mt-10">
        <input
            id="message"
            type="text"
            placeholder="Escribe tu pregunta..."
            class="flex-grow input input-ghost border-none focus:outline-none bg-base-200"
        />
        <button onclick="sendMessage()" class="btn btn-ghost btn-square">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5 12h14M12 5l7 7-7 7" />
            </svg>
        </button>
    </div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
<script>
    // Connect to WebSocket server
    var socket = io("http://localhost:5000");

    let loaderElement = null;

    // Handle incoming messages from the server
    socket.on("response", function(data) {
        removeLoader(); // Remove loading message
        appendMessage(data, "ai");
    });
    
    function showLoader() {
    const chatBox = document.getElementById("chat-box");
    const loader = document.createElement("div");
    loader.classList.add("chat", "chat-start");
    
    const bubble = document.createElement("div");
    bubble.classList.add("chat-bubble");
    bubble.classList.add("opacity-60", "italic");
    bubble.textContent = "Escribiendo...";

    loader.appendChild(bubble);
    chatBox.appendChild(loader);
    chatBox.scrollTop = chatBox.scrollHeight;

    loaderElement = loader;
}

function removeLoader() {
    if (loaderElement) {
        loaderElement.remove();
        loaderElement = null;
    }
}

    // Function to send messages
    function sendMessage() {
        var input = document.getElementById("message");
        var userMessage = input.value.trim();
        if (userMessage === "") return;
        

        // ðŸ§¼ Hide the welcome section if it's visible
        var welcome = document.getElementById("welcome-section");
        if (welcome) {
            welcome.style.display = "none";
            document.getElementById("chat-box").classList.remove("hidden");
        }

        appendMessage(userMessage, "user");

        showLoader(); // Show loader

        
        socket.send(userMessage); // Send message to the WebSocket server
        input.value = ""; // Clear input field
    }

    function appendMessage(message, type) {
        var chatBox = document.getElementById("chat-box");
        var chatMessage = document.createElement("div");

        chatMessage.classList.add("chat");
        chatMessage.classList.add(type === "ai" ? "chat-start" : "chat-end");
            
        var messageBubble = document.createElement("div");
        messageBubble.classList.add("chat-bubble");
        messageBubble.textContent = message;

        chatMessage.appendChild(messageBubble);

        chatBox.appendChild(chatMessage);

        chatBox.scrollTop = chatBox.scrollHeight;
    }
    function quickSend(text) {
        // ðŸ§¼ Hide the welcome section if it's visible
        var welcome = document.getElementById("welcome-section");
        if (welcome) {
            welcome.style.display = "none";
            document.getElementById("chat-box").classList.remove("hidden");
        }
      appendMessage(text, "user");
        showLoader(); // Show loader

      socket.send(text);
    }
    

document.addEventListener("DOMContentLoaded", function () {
  const notifContainer = document.getElementById("notification-container");
  if (notifContainer) {
    notifContainer.querySelectorAll("svg[id^='close-notif-']").forEach(svg => {
      svg.addEventListener("click", function () {
        const alert = svg.closest(".alert");
        if (alert) alert.remove();
      });
    });

    // Auto remove notifications after 4 seconds
    notifContainer.querySelectorAll(".alert").forEach(alert => {
      setTimeout(() => {
        alert.remove();
      }, 4000);
    });
  }
});
</script>
{% endblock %}