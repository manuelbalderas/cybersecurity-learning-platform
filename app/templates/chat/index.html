{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4">
    <h2 class="text-2xl font-bold">Chatea con Pwnie</h2>
    
    <div id="chat-box" class="border p-4 h-80 overflow-y-auto bg-base-200 rounded">
        <!-- Messages will be displayed here -->
    </div>

    <div class="mt-4 flex">
        <input id="message" type="text" placeholder="Escribe un mensaje..."
            class="input input-bordered flex-1 mr-2"/>
        <button onclick="sendMessage()" class="btn btn-primary">Enviar</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
<script>
    // Connect to WebSocket server
    var socket = io("http://localhost:5000");

    // When connected
    socket.on("connect", function() {
        console.log("Conectado al servidor WebSocket");
        appendMessage("🟢 Conectado al chat", "system");
    });

    // Handle incoming messages from the server
    socket.on("response", function(data) {
        appendMessage(data, "bot");
    });

    // Handle disconnection
    socket.on("disconnect", function() {
        appendMessage("🔴 Desconectado del chat", "system");
    });

    // Function to send messages
    function sendMessage() {
        var input = document.getElementById("message");
        var userMessage = input.value.trim();
        if (userMessage === "") return;

        appendMessage("🧑‍💻 Tú: " + userMessage, "user");
        
        socket.send(userMessage); // Send message to the WebSocket server
        input.value = ""; // Clear input field
    }

    function appendMessage(message, type) {
        var chatBox = document.getElementById("chat-box");
        var chatMessage = document.createElement("div");

        if (type === "user") {
            chatMessage.classList.add("chat", "chat-end");
            
            var userBubble = document.createElement("div");
            userBubble.classList.add("chat-bubble");
            userBubble.textContent = message;

            chatMessage.appendChild(userBubble);
        } else if (type === "bot") {
            chatMessage.classList.add("chat", "chat-start");

            var chatHeader = document.createElement("div");
            chatHeader.classList.add("chat-header");
            chatHeader.textContent = "🤖 Pwnie";

            var botBubble = document.createElement("div");
            botBubble.classList.add("chat-bubble");
            botBubble.textContent = message;

            chatMessage.appendChild(chatHeader);
            chatMessage.appendChild(botBubble);
        } else {
            chatMessage.classList.add("chat", "chat-center");

            var systemBubble = document.createElement("div");
            systemBubble.classList.add("chat-bubble", "italic", "text-gray-500");
            systemBubble.textContent = message;

            chatMessage.appendChild(systemBubble);
        }

        chatBox.appendChild(chatMessage);

        chatBox.scrollTop = chatBox.scrollHeight;
    }


</script>
{% endblock %}